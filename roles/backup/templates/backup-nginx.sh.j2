#!/bin/bash

TIMESTAMP=$(date +"%F")
BACKUP="/var/backups/nginx"
BACKUPDIR="$BACKUP/$TIMESTAMP"
AGE=7

mkdir -p "$BACKUPDIR"

if [ ! -d $BACKUPDIR ]; then
	echo "Backup destination folder: $BACKUPDIR does not exist."; echo
	exit 1
fi

for dir in /var/www/accounts/*
do
  base=$(basename "$dir")
  tar -zcf --warning=no-file-changed "$BACKUPDIR/$base.tar.gz" --exclude-tag-all=.do-not-backup -C  /var/www/accounts "${base}"
done

zip -q -s 500m -r $BACKUPDIR.zip $BACKUPDIR/*

#tar -zcf $BACKUPDIR.tar.gz -C $BACKUP $TIMESTAMP

if test $? -eq 0
then
	rm -rf $BACKUPDIR
else
	echo "Backup file not created." >&2
	exit 1
fi

# echo "Cleaning up old backups (older than $AGE days) and temporary files"
find $BACKUP -mindepth 1 -maxdepth 1 -ctime +$AGE -exec rm -rf {} \;

ncftpput -V -t 10800 Backup /BigMike/nginx $BACKUP/$TIMESTAMP.z*
rsync --ignore-existing $BACKUP/$TIMESTAMP.z* backups@chuck.net-labs.pl:~/backup/bigmike/nginx/

exit 0
